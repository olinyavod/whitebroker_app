# Руководство по автоматическому сохранению куков

## Обзор

Система автоматического сохранения куков обеспечивает постоянное сохранение состояния авторизации пользователя в приложении White Broker. Это предотвращает потерю авторизации при перезапуске приложения.

## Архитектура

### Компоненты

1. **CookieManager** (`Services/CookieManager.cs`)
   - Основной менеджер для сохранения и загрузки куков
   - Сохраняет куки в JSON файл в `FileSystem.AppDataDirectory`
   - Автоматически фильтрует просроченные куки при загрузке

2. **Platform Handlers**
   - `Platforms/Android/WebViewHandler.cs` - обработчик для Android
   - `Platforms/iOS/WebViewHandler.cs` - обработчик для iOS
   - Каждый обработчик имеет специфичную для платформы логику работы с куками

3. **MainPage** (`MainPage.xaml.cs`)
   - Интегрирует CookieManager
   - Автоматически сохраняет куки каждые 30 секунд
   - Сохраняет куки при навигации и закрытии страницы

## Как это работает

### Загрузка куков

При инициализации WebView:

1. **Android:**
   ```csharp
   var androidCookieManager = CookieManager.Instance;
   androidCookieManager.SetAcceptCookie(true);
   androidCookieManager.SetAcceptThirdPartyCookies(webView, true);
   ```
   
2. **iOS:**
   ```csharp
   config.WebsiteDataStore = WKWebsiteDataStore.DefaultDataStore;
   ```

3. Загружаются сохраненные куки из файла `cookies.json`
4. Куки устанавливаются в соответствующий менеджер куков платформы

### Сохранение куков

Куки сохраняются автоматически в следующих случаях:

1. **Периодически** - каждые 30 секунд (через таймер)
2. **После навигации** - когда страница успешно загружена
3. **При закрытии** - когда пользователь закрывает страницу

### Формат хранения

Куки сохраняются в JSON файле со следующей структурой:

```json
[
  {
    "Name": "session_token",
    "Value": "abc123...",
    "Domain": "wb.easy-prog.ru",
    "Path": "/",
    "ExpiresUnixTime": 1735689600,
    "Secure": true,
    "HttpOnly": false
  }
]
```

## Настройка

### Изменение домена

Если необходимо изменить целевой домен, измените константу в `MainPage.xaml.cs`:

```csharp
private const string TargetDomain = "wb.easy-prog.ru";
```

### Изменение интервала сохранения

Для изменения частоты автоматического сохранения куков, измените значение таймера в `MainPage.xaml.cs`:

```csharp
_cookieSaveTimer = new System.Timers.Timer(30000); // 30 секунд
```

### Ручное управление куками

Для ручного управления куками можно использовать методы `CookieManager`:

```csharp
// Загрузка куков
var cookies = await _cookieManager.LoadCookiesAsync();

// Сохранение куков
await _cookieManager.SaveCookiesAsync(cookies);

// Очистка куков
await _cookieManager.ClearCookiesAsync();
```

## Debugging

В режиме DEBUG в консоль выводятся сообщения о работе с куками:

- `[CookieManager] Сохранено X куков` - успешное сохранение
- `[CookieManager] Загружено X валидных куков` - успешная загрузка
- `[Android WebView] Восстановлено X куков` - куки восстановлены на Android
- `[iOS WebView] Восстановлено X куков` - куки восстановлены на iOS
- `[Cookie Manager] Куки сохранены` - периодическое сохранение

## Особенности платформ

### Android

- Использует `Android.Webkit.CookieManager`
- Поддерживает сторонние куки через `SetAcceptThirdPartyCookies`
- Требует вызова `Flush()` для немедленного сохранения

### iOS

- Использует `WKHTTPCookieStore` из `WKWebsiteDataStore`
- Поддерживает асинхронную работу с куками
- Автоматически синхронизирует куки между WebView и NSURLSession

## Безопасность

1. **Локальное хранение** - куки сохраняются локально на устройстве
2. **Secure флаг** - поддерживается для HTTPS
3. **HttpOnly флаг** - сохраняется для защиты от XSS
4. **Фильтрация** - просроченные куки автоматически удаляются при загрузке

## Известные ограничения

1. Куки сохраняются только для указанного домена (`wb.easy-prog.ru`)
2. Сессионные куки конвертируются в постоянные (1 год по умолчанию)
3. На Android парсинг куков упрощен (не все атрибуты распознаются)

## Устранение неполадок

### Куки не сохраняются

1. Проверьте, что `CookieManager` правильно внедрен в `MauiProgram.cs`
2. Убедитесь, что таймер запущен в `MainPage.xaml.cs`
3. Проверьте логи в режиме DEBUG

### Куки не загружаются

1. Убедитесь, что файл `cookies.json` существует в `FileSystem.AppDataDirectory`
2. Проверьте, что куки не просрочены
3. Проверьте совместимость домена

### Авторизация все равно слетает

1. Убедитесь, что серверные куки имеют достаточный срок действия
2. Проверьте, что все необходимые куки сохраняются
3. Убедитесь, что домен указан правильно

## Дальнейшее развитие

Возможные улучшения:

1. Шифрование куков для дополнительной безопасности
2. Поддержка нескольких доменов
3. UI для просмотра и управления куками
4. Автоматическая очистка старых куков
5. Синхронизация куков между устройствами

